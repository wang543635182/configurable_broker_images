version: '3'
services:
  haproxy:
    image: wind634/haproxy-redis:ha
    labels:
      - "io.daocloud.dce.service.role=proxy"
      - "io.daocloud.dce.service.console=true"
      - io.daocloud.dce.compose.placement.constraints=["node.labels.redis == redis"]
    ports:
      - "6379:6379"
    command: haproxy -f /usr/local/etc/haproxy/haproxy.cfg
#    cpu_quota: 50000
    environment:
      - APPNAME={{appname}}
      - REDIS_AUTH_PASSWORD={{PASSWORD}}
      - STARTORDER=7
      - HAPROXY_BALANCE=source
      - HAPROXY_MAXCONN=4096
      - HAPROXY_CONNECT_TIMEOUT=5000
      - HAPROXY_SERVER_TIMEOUT=50000
      - HAPROXY_CLIENT_TIMEOUT=50000
      - HAPROXY_BALANCE=roundrobin
  master:
    image: wind634/redis:ha
    command: --appendonly yes --masterauth {{PASSWORD}}
    labels:
      - "io.daocloud.dce.service.role=master"
      - "io.daocloud.dce.compose.endpoint-spec.mode=dnsrr"
      - io.daocloud.dce.compose.placement.constraints=["node.labels.servicepool1 == servicepool1", "node.labels.redis == redis"]
    volumes:
      - /data
#    cpu_quota: 80000
    environment:
      - STARTORDER=0
      - REDIS_TIMEOUT=0
      - REDIS_MAXMEMORY={{REDIS_MAXMEMORY}}
      - REDIS_RDB_COMPRESSION=no
      - REDIS_APPEND_ONLY=no
      - REDIS_APPEND_FSYNC=everysec
      - REDIS_MAXMEMORY_POLICY=volatile-lru
      - REDIS_PASSWORD={{PASSWORD}}
  slave:
    image: wind634/redis:ha
    labels:
      - "io.daocloud.dce.service.role=slave"
      - "io.daocloud.dce.compose.endpoint-spec.mode=dnsrr"
      - io.daocloud.dce.compose.placement.constraints=["node.labels.servicepool2 == servicepool2", "node.labels.redis == redis"]
    volumes:
      - /data
    command:  --slaveof {{appname}}_master 6379 --appendonly yes --masterauth {{PASSWORD}}
#    restart: unless-stopped
#    cpu_quota: 50000
    environment:
      - STARTORDER=1
      - REDIS_TIMEOUT=0
      - REDIS_MAXMEMORY={{REDIS_MAXMEMORY}}
      - REDIS_RDB_COMPRESSION=no
      - REDIS_APPEND_ONLY=no
      - REDIS_APPEND_FSYNC=everysec
      - REDIS_MAXMEMORY_POLICY=volatile-lru
      - REDIS_PASSWORD={{PASSWORD}}
    depends_on:
      - master
  slave1:
    image: wind634/redis:ha
    labels:
      - "io.daocloud.dce.service.role=slave"
      - "io.daocloud.dce.compose.endpoint-spec.mode=dnsrr"
      - io.daocloud.dce.compose.placement.constraints=["node.labels.servicepool3 == servicepool3", "node.labels.redis == redis"]
    volumes:
      - /data
    command: --slaveof {{appname}}_master 6379 --appendonly yes --masterauth {{PASSWORD}}
#    restart: unless-stopped
#    cpu_quota: 50000
    environment:
      - STARTORDER=2
      - REDIS_TIMEOUT=0
      - REDIS_MAXMEMORY={{REDIS_MAXMEMORY}}
      - REDIS_RDB_COMPRESSION=no
      - REDIS_APPEND_ONLY=no
      - REDIS_APPEND_FSYNC=everysec
      - REDIS_MAXMEMORY_POLICY=volatile-lru
      - REDIS_PASSWORD={{PASSWORD}}
    depends_on:
      - master
  sentinel0:
    image: wind634/redis-sentinel:ha
    labels:
      - io.daocloud.dce.compose.placement.constraints=["node.labels.servicepool1 == servicepool1", "node.labels.redis == redis"]
    ports:
      - "26379"
    environment:
      - APPNAME={{appname}}
      - REDIS_SENTINEL_DOWN_AFTER_MILLISECONDS=30000
      - REDIS_SENTINEL_PASSWORD={{PASSWORD}}
      - REDIS_SENTINEL_MASTER_HOST={{appname}}_master
      - REDIS_SENTINEL_PARALLEL_SYNCS=1
      - REDIS_SENTINEL_FAILOVER_TIMEOUT=180000
      - STARTORDER=3
    depends_on:
      - master
      - slave
      - slave1
#    cpu_quota: 50000
  sentinel1:
    image: wind634/redis-sentinel:ha
    labels:
      - io.daocloud.dce.compose.placement.constraints=["node.labels.servicepool2 == servicepool2", "node.labels.redis == redis"]
    ports:
      - "26379"
    environment:
      - APPNAME={{appname}}
      - REDIS_SENTINEL_DOWN_AFTER_MILLISECONDS=30000
      - REDIS_SENTINEL_PASSWORD={{PASSWORD}}
      - REDIS_SENTINEL_MASTER_HOST={{appname}}_master
      - REDIS_SENTINEL_PARALLEL_SYNCS=1
      - REDIS_SENTINEL_FAILOVER_TIMEOUT=180000
      - STARTORDER=4
    depends_on:
      - master
      - slave
      - slave1
#    cpu_quota: 50000
  sentinel2:
    image: wind634/redis-sentinel:ha
    labels:
      - io.daocloud.dce.compose.placement.constraints=["node.labels.servicepool3 == servicepool3", "node.labels.redis == redis"]
    ports:
      - "26379"
    environment:
      - APPNAME={{appname}}
      - REDIS_SENTINEL_DOWN_AFTER_MILLISECONDS=30000
      - REDIS_SENTINEL_PASSWORD={{PASSWORD}}
      - REDIS_SENTINEL_MASTER_HOST={{appname}}_master
      - REDIS_SENTINEL_PARALLEL_SYNCS=1
      - REDIS_SENTINEL_FAILOVER_TIMEOUT=180000
      - STARTORDER=5
    depends_on:
      - master
      - slave
      - slave1
#    restart: unless-stopped
#    cpu_quota: 50000
#  exporter:
#    image: daocloud.io/daocloud/servicebroker-exporter
#    labels:
#      - "io.daocloud.dce.service.role=exporter"
#    environment:
#      - STARTORDER=6
#      - APPTYPE=redis-ha
#      - APPNAME={{appname}}
#      - HOSTS=redis:master:master:6379,redis:slave:slave:6379,sentinel:sentinel:sentinel:26379,haproxy:haproxy:haproxy:6379 # host=type:role:host:port
#      - USERNAME=redis_has_no_user
#      - PASSWORD={{PASSWORD}}
#    ports:
#      - '9120'